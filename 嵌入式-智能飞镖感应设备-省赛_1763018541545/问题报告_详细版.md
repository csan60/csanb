# 智能飞镖感应设备 - 问题报告

## 📋 报告基本信息

| 项目 | 内容 |
|------|------|
| 项目名称 | 智能飞镖感应设备 |
| 测试日期 | 2025年 |
| 测试人员 | 测试团队 |
| 报告版本 | v1.0 |
| 被测系统版本 | v1.0 |

---

## 📊 测试概况

### 测试范围
- ✅ 飞镖信息输入功能（需求2.2）
- ✅ 靶区信息接收功能（需求2.3）
- ✅ 得分逻辑处理（需求2.4）
- ✅ 成绩评定功能（需求2.5）
- ✅ 系统状态控制（需求2.6）
- ✅ 数据传送机接口（需求3.1）
- ✅ 靶体接口（需求3.2）

### 测试统计
- 总测试用例数: **50+**
- 执行用例数: **50+**
- 通过用例数: **待确认**
- 失败用例数: **待确认**
- 发现问题数: **10个**

---

## 🔴 高频十大典型问题详细报告

### 问题 #1: 非"准备投镖"状态仍能接收飞镖输入

**需求编号**: 2.2-002  
**问题类型**: 状态机错误  
**严重程度**: 🔴 高

#### 问题描述
系统在非"准备投镖"状态下（如"投镖结束"状态），仍然能够接收并处理飞镖信息输入，违反了状态机设计原则。

#### 复现步骤
1. 将系统切换到"投镖结束"状态
2. 通过COM接口1发送飞镖信息数据包：
   ```
   包头: 0xAA55
   数据标志: 0xBB
   飞镖类型: 0x01 (轻镖)
   飞镖数量: 0x0A (10枚)
   校验和: (自动计算)
   包尾: 0x55AA
   ```
3. 观察系统是否接收该信息

#### 预期行为
系统应拒绝接收飞镖信息，不更新显示内容。

#### 实际行为
系统接收并显示了飞镖信息，状态机未限制输入。

#### 问题根源
未在飞镖信息输入模块中添加状态检查逻辑，缺少对当前状态的判断。

#### 建议修复方案
```c
// 伪代码示例
void ProcessDartInput(DartInfo* info) {
    // 添加状态检查
    if (currentState != STATE_READY_TO_THROW) {
        // 拒绝输入，记录日志
        LogError("Invalid state for dart input");
        return;
    }
    // 原有处理逻辑
    UpdateDartInfo(info);
}
```

#### 影响范围
- 用户体验：可能导致数据混乱
- 系统稳定性：中等影响
- 功能完整性：高影响

---

### 问题 #2: 点击"开始"后无倒计时启动

**需求编号**: 2.3-001  
**问题类型**: 功能缺失  
**严重程度**: 🔴 高

#### 问题描述
在"准备投镖"状态下点击"开始"按钮后，系统未启动倒计时功能，无法进入"开始投镖"状态。

#### 复现步骤
1. 确保系统处于"准备投镖"状态
2. 输入飞镖信息
3. 点击"开始"按钮
4. 观察倒计时是否启动

#### 预期行为
- 倒计时启动并开始递减
- 系统状态切换为"开始投镖"
- 倒计时结束后自动进入"投镖结束"状态

#### 实际行为
点击"开始"按钮后无任何反应，倒计时未启动。

#### 问题根源
"开始"按钮的事件处理函数中未调用倒计时模块，或倒计时模块未初始化。

#### 建议修复方案
```c
// 伪代码示例
void OnStartButtonClick() {
    if (currentState == STATE_READY_TO_THROW) {
        // 启动倒计时
        StartCountdown(COUNTDOWN_DURATION);
        // 切换状态
        currentState = STATE_THROWING;
        UpdateUI();
    }
}

void CountdownCallback() {
    if (remainingTime > 0) {
        remainingTime--;
        UpdateCountdownDisplay();
    } else {
        // 倒计时结束
        currentState = STATE_THROW_END;
        OnThrowingEnd();
    }
}
```

#### 影响范围
- 核心功能：完全无法使用
- 严重程度：非常高
- 用户体验：严重影响

---

### 问题 #3: 轻镖命中"内牛眼"得分错误

**需求编号**: 2.4-001  
**问题类型**: 逻辑失配  
**严重程度**: 🔴 高

#### 问题描述
轻型飞镖（type=1）命中"内牛眼"区域（zone=1）时，系统只加3分，但根据需求应加5分。

#### 复现步骤
1. 输入飞镖类型：1（轻镖）
2. 发送靶区数据：zone=1（内牛眼）
3. 观察得分变化

#### 预期行为
得分增加 **5分**

#### 实际行为
得分只增加 **3分**

#### 得分规则参考
| 飞镖类型 | 内牛眼(1) | 外牛眼(2) | 三倍区(3) | 普通区(4-20) |
|---------|----------|----------|----------|-------------|
| 轻镖(1) | **5分**  | 3分      | 2分      | 1分         |
| 重镖(2) | 3分      | 2分      | 2分      | 1分         |

#### 问题根源
得分计算表或条件判断逻辑错误，可能是：
- 得分表中轻镖内牛眼配置为3分
- 判断条件写错（如 if zone==1 then score=3）

#### 建议修复方案
```c
// 伪代码示例
int CalculateScore(int dartType, int zone) {
    if (dartType == LIGHT_DART) {
        if (zone == 1) return 5;      // 修正：内牛眼5分
        else if (zone == 2) return 3; // 外牛眼3分
        else if (zone == 3) return 2; // 三倍区2分
        else return 1;                // 普通区1分
    } else if (dartType == HEAVY_DART) {
        // 重镖逻辑...
    }
    return 0;
}
```

#### 影响范围
- 核心功能：得分计算错误
- 用户影响：高（直接影响比赛结果）
- 数据准确性：严重影响

---

### 问题 #4: 重镖命中"三倍区"得分错误

**需求编号**: 2.4-002  
**问题类型**: 算法错误  
**严重程度**: 🔴 高

#### 问题描述
重型飞镖（type=2）命中"三倍区"（zone=3）时，系统只加1分，但根据需求应加2分。

#### 复现步骤
1. 输入飞镖类型：2（重镖）
2. 发送靶区数据：zone=3（三倍区）
3. 观察得分变化

#### 预期行为
得分增加 **2分**

#### 实际行为
得分只增加 **1分**

#### 问题根源
重镖得分逻辑的分支判断错误，三倍区被当作普通区处理。

#### 建议修复方案
```c
// 伪代码示例
int CalculateScore(int dartType, int zone) {
    if (dartType == HEAVY_DART) {
        if (zone == 1) return 3;      // 内牛眼3分
        else if (zone == 2) return 2; // 外牛眼2分
        else if (zone == 3) return 2; // 修正：三倍区2分（不是1分）
        else return 1;                // 普通区1分
    }
    // ...
}
```

#### 影响范围
- 核心功能：得分计算错误
- 用户影响：高
- 公平性：影响比赛结果

---

### 问题 #5: 时间结束后仍接收得分信息

**需求编号**: 2.5-001  
**问题类型**: 终态未封锁  
**严重程度**: 🔴 高

#### 问题描述
倒计时结束后，系统仍然接收并处理靶区信息，继续累加得分，应在时间结束后封锁输入。

#### 复现步骤
1. 启动倒计时
2. 等待倒计时结束
3. 记录当前得分（如20分）
4. 发送靶区数据：zone=1（内牛眼）
5. 观察得分是否变化

#### 预期行为
得分保持不变（20分），系统拒绝接收靶区信息。

#### 实际行为
得分继续增加（如变为25分），系统未拒绝超时输入。

#### 问题根源
靶区信息处理模块未检查倒计时状态，缺少终态封锁机制。

#### 建议修复方案
```c
// 伪代码示例
void ProcessTargetHit(int zone) {
    // 添加倒计时检查
    if (countdownFinished || currentState == STATE_THROW_END) {
        LogError("Timeout: target hit rejected");
        return; // 拒绝输入
    }
    
    // 原有逻辑
    int score = CalculateScore(currentDartType, zone);
    totalScore += score;
    UpdateScoreDisplay();
}
```

#### 影响范围
- 公平性：严重影响（可作弊）
- 系统可靠性：高影响
- 用户信任度：严重影响

---

### 问题 #6: 非"投镖结束"状态下点击"复位"仍清空数据

**需求编号**: 2.6-001  
**问题类型**: 数据异常  
**严重程度**: 🟡 中

#### 问题描述
在"准备投镖"或"投镖中"状态下点击"复位"按钮，系统仍然清空了所有数据，但应只在"投镖结束"状态下响应复位操作。

#### 复现步骤
1. 在"准备投镖"状态下输入飞镖信息
2. 点击"复位"按钮
3. 观察数据是否被清空

#### 预期行为
系统无反应，数据保持不变。

#### 实际行为
数据被清空，回到初始状态。

#### 问题根源
复位按钮的事件处理函数中未检查当前状态。

#### 建议修复方案
```c
// 伪代码示例
void OnResetButtonClick() {
    if (currentState == STATE_THROW_END) {
        // 只在投镖结束状态响应复位
        ClearAllData();
        currentState = STATE_READY_TO_THROW;
        UpdateUI();
    } else {
        // 其他状态下忽略复位操作
        LogWarning("Reset ignored: invalid state");
    }
}
```

#### 影响范围
- 用户体验：中等影响
- 数据安全：中等影响
- 误操作风险：高

---

### 问题 #7: 校验错误数据帧未被丢弃（接口1）

**需求编号**: 3.1-001  
**问题类型**: 协议漏洞  
**严重程度**: 🔴 高

#### 问题描述
数据传送机接口（COM接口1）未正确实现数据包校验，校验和错误的数据帧仍被系统接收并处理。

#### 复现步骤
1. 构造校验和错误的数据包：
   ```
   包头: 0xAA55
   数据标志: 0xBB
   飞镖类型: 0x01
   飞镖数量: 0x0A
   校验和: 0xFF (错误值，正确应为0x??）
   包尾: 0x55AA
   ```
2. 发送该数据包
3. 观察系统是否接收

#### 预期行为
系统丢弃该数据包，不处理任何信息。

#### 实际行为
系统接收并处理了该数据包。

#### 问题根源
未实现校验逻辑，或校验函数未被调用。

#### 建议修复方案
```c
// 伪代码示例
bool VerifyChecksum(uint8_t* data, int len) {
    uint8_t sum = 0;
    for (int i = 0; i < len - 1; i++) {
        sum += data[i];
    }
    return (sum == data[len - 1]);
}

void ProcessReceivedPacket(Packet* pkt) {
    // 校验包头
    if (pkt->header != 0xAA55) {
        LogError("Invalid header");
        return;
    }
    
    // 校验和检查
    if (!VerifyChecksum(pkt->data, pkt->dataLen)) {
        LogError("Checksum error");
        return; // 丢弃数据包
    }
    
    // 校验包尾
    if (pkt->tail != 0x55AA) {
        LogError("Invalid tail");
        return;
    }
    
    // 处理有效数据
    ProcessValidData(pkt);
}
```

#### 影响范围
- 数据完整性：严重影响
- 系统可靠性：高影响
- 通信质量：严重影响

---

### 问题 #8: 区域数据包字段非法仍被接收（接口2）

**需求编号**: 3.2-001  
**问题类型**: 数据污染  
**严重程度**: 🔴 高

#### 问题描述
靶体接口（COM接口2）未对区域字段进行有效性校验，非法区域值（如zone=0, zone=21, zone=6等）仍被系统接收并记录进得分。

#### 复现步骤
1. 发送区域为6的数据包（超出1-5有效范围）：
   ```
   包头: 0xAA55
   数据标志1: 0xCC
   区域: 0x06 (非法值)
   数据标志2: 0x11
   校验和: (自动计算)
   包尾: 0x55AA
   ```
2. 观察系统是否接收并处理

#### 预期行为
系统丢弃该数据包，得分不变。

#### 实际行为
系统接收并处理了该数据，得分异常增加。

#### 有效区域范围
根据需求文档，有效区域应为：
- **内牛眼**: zone = 1
- **外牛眼**: zone = 2
- **三倍区**: zone = 3
- **普通区**: zone = 4-20

任何超出 1-20 范围的值都应被拒绝。

#### 问题根源
未实现区域有效性检查。

#### 建议修复方案
```c
// 伪代码示例
bool IsValidZone(int zone) {
    return (zone >= 1 && zone <= 20);
}

void ProcessTargetData(TargetPacket* pkt) {
    // 校验区域有效性
    if (!IsValidZone(pkt->zone)) {
        LogError("Invalid zone: %d", pkt->zone);
        return; // 拒绝非法区域
    }
    
    // 处理有效区域数据
    int score = CalculateScore(currentDartType, pkt->zone);
    totalScore += score;
    UpdateScoreDisplay();
}
```

#### 影响范围
- 数据准确性：严重影响
- 得分正确性：高影响
- 系统可靠性：中等影响

---

### 问题 #9: 成绩评定分区错误

**需求编号**: 2.5-002  
**问题类型**: 算法失准  
**严重程度**: 🟡 中

#### 问题描述
轻镖平均得分为2.0分时，系统评定为"差"，但根据需求应评定为"良"。

#### 复现步骤
1. 投10枚轻镖
2. 总得分20分（平均2.0分）
3. 观察成绩评定

#### 预期行为
显示成绩评定："良"

#### 实际行为
显示成绩评定："差"

#### 评定标准
根据需求文档：
| 评定等级 | 平均得分范围 |
|---------|-------------|
| 优秀 | average >= 2.5 |
| 良 | 2.5 > average >= 2.0 |
| 差 | average < 2.0 |

**关键点**: average = 2.0 应属于"良"，不是"差"

#### 问题根源
区间判断公式逻辑错误，可能是：
```c
// 错误的逻辑
if (average > 2.0)  // 应该是 >=
    grade = "良";
else
    grade = "差";
```

#### 建议修复方案
```c
// 正确的逻辑
const char* GetGrade(float average) {
    if (average >= 2.5) {
        return "优秀";
    } else if (average >= 2.0) {  // 修正：>= 而不是 >
        return "良";
    } else {
        return "差";
    }
}
```

#### 边界值测试建议
| 平均分 | 预期评定 | 说明 |
|--------|---------|------|
| 2.6 | 优秀 | 正常情况 |
| 2.5 | 良 或 优秀 | 边界值，需明确 |
| 2.0 | **良** | **本问题的关键** |
| 1.9 | 差 | 正常情况 |

#### 影响范围
- 成绩评定准确性：中等影响
- 用户满意度：中等影响
- 边界条件处理：需加强

---

### 问题 #10: 飞镖数量字段为nil时系统崩溃

**需求编号**: 2.2-003  
**问题类型**: 崩溃级别  
**严重程度**: 🔴 高

#### 问题描述
当飞镖数量字段缺失或为nil时，系统直接崩溃，报错：`attempt to compare nil with number`

#### 复现步骤
1. 发送缺少飞镖数量字段的数据包
2. 或发送飞镖数量为nil的数据
3. 观察系统响应

#### 预期行为
- 系统检测到字段缺失
- 使用默认值（如number=1）或提示错误
- 系统不应崩溃

#### 实际行为
系统崩溃，错误信息：
```
Error: attempt to compare nil with number
  at line 45 in process_dart_input()
```

#### 问题根源
未对输入数据进行空值校验，直接使用可能为nil的变量进行数值比较。

#### 建议修复方案
```c
// 伪代码示例
void ProcessDartInput(DartPacket* pkt) {
    // 空值校验
    int dartType = (pkt->type != NULL) ? pkt->type : DEFAULT_DART_TYPE;
    int dartNumber = (pkt->number != NULL) ? pkt->number : DEFAULT_DART_NUMBER;
    
    // 范围校验
    if (dartNumber <= 0 || dartNumber > MAX_DART_NUMBER) {
        LogError("Invalid dart number: %d", dartNumber);
        dartNumber = DEFAULT_DART_NUMBER;
    }
    
    // 安全使用数据
    UpdateDartInfo(dartType, dartNumber);
}
```

#### 防御性编程建议
```c
// 通用的空值检查宏
#define SAFE_GET_INT(ptr, default) ((ptr) ? *(ptr) : (default))

// 使用示例
int number = SAFE_GET_INT(&pkt->number, 1);
```

#### 影响范围
- 系统稳定性：严重影响（崩溃）
- 用户体验：极差
- 优先级：最高

---

## 📋 问题优先级排序

### P0 - 最高优先级（立即修复）
1. 🔴 问题 #10: 飞镖数量为nil崩溃（崩溃级）
2. 🔴 问题 #2: 无倒计时启动（功能完全不可用）

### P1 - 高优先级（尽快修复）
1. 🔴 问题 #3: 轻镖内牛眼得分错误
2. 🔴 问题 #4: 重镖三倍区得分错误
3. 🔴 问题 #5: 超时后仍接收得分
4. 🔴 问题 #7: 校验错误未丢弃
5. 🔴 问题 #8: 非法区域未校验
6. 🔴 问题 #1: 非准备状态仍能输入

### P2 - 中等优先级（计划修复）
1. 🟡 问题 #6: 非结束状态下复位清空数据
2. 🟡 问题 #9: 成绩评定分区错误

---

## 📊 问题统计分析

### 按类型统计
| 问题类型 | 数量 | 占比 |
|---------|------|------|
| 状态机错误 | 3 | 30% |
| 得分逻辑错误 | 2 | 20% |
| 数据校验缺失 | 3 | 30% |
| 功能缺失 | 1 | 10% |
| 异常处理不足 | 1 | 10% |

### 按严重程度统计
| 严重程度 | 数量 | 占比 |
|---------|------|------|
| 🔴 高 | 8 | 80% |
| 🟡 中 | 2 | 20% |
| 🟢 低 | 0 | 0% |

### 按模块统计
| 模块 | 问题数 | 关键问题 |
|------|--------|---------|
| 状态控制 | 4 | #1, #2, #5, #6 |
| 得分计算 | 3 | #3, #4, #9 |
| 接口校验 | 2 | #7, #8 |
| 异常处理 | 1 | #10 |

---

## 🔍 根本原因分析

### 共性问题
1. **缺少输入校验**: 多个模块未对输入数据进行有效性检查
2. **状态机设计不完善**: 未充分考虑状态转换的限制条件
3. **边界条件处理不足**: 边界值判断逻辑存在错误
4. **异常处理缺失**: 对异常数据缺少防御性编程

### 建议改进措施
1. ✅ 建立统一的输入校验框架
2. ✅ 完善状态机设计，添加状态转换表
3. ✅ 增强边界条件测试
4. ✅ 实施防御性编程实践
5. ✅ 添加详细的错误日志机制

---

## 📝 测试建议

### 回归测试清单
完成修复后，建议进行以下回归测试：
- [ ] 状态机完整流程测试
- [ ] 所有得分组合测试（2种飞镖 × 4种区域）
- [ ] 接口校验完整性测试（包头、包尾、数据标志、校验和）
- [ ] 边界值测试（zone=0,1,20,21; number=0,1,999）
- [ ] 异常数据测试（nil值、负数、超大值）
- [ ] 成绩评定边界测试（1.9, 2.0, 2.5, 2.6分）

### 新增测试建议
1. 压力测试：连续快速发送数据包
2. 并发测试：同时发送飞镖和靶区数据
3. 长时间运行测试：24小时稳定性测试
4. 异常注入测试：模拟各种异常情况

---

## 📞 联系信息

**测试团队**: 质量保证部  
**联系人**: [测试负责人]  
**邮箱**: [测试团队邮箱]  
**电话**: [联系电话]

---

## 📌 附录

### A. 测试数据示例
详见 `testdata/data.yml`

### B. 测试脚本列表
- `func/1shoot.lua` - 飞镖信息输入测试
- `func/2target.lua` - 靶区信息接收测试
- `func/3interface_shoot.lua` - 数据传送机接口测试
- `func/4interface_target.lua` - 靶体接口测试
- `func/5scoring_test.lua` - 得分逻辑测试
- `func/6state_machine_test.lua` - 状态机测试
- `func/7performance_test.lua` - 成绩评定测试
- `func/8exception_test.lua` - 异常数据测试

### C. 需求文档参考
详见 `CST2025嵌入式分赛--省赛--需求文档.pdf`

---

**报告结束**

---

_本报告基于2025年测试结果编写，包含10个高频典型问题的详细分析。建议开发团队按优先级依次修复，并进行充分的回归测试。_
